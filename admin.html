<!-- admin.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AL ZOZ ‚Äî Manage Products</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="sidebar">
    <div class="logo"><img src="logo.png" alt="AL ZOZ Logo"></div>
    <a href="index.html">üõí Products</a>
    <a href="offers.html">üî• Hot Offers</a>
    <a href="contact.html">üìû Contact</a>
    <a href="dashboard.html">üìä Dashboard</a>
    <a href="admin.html">‚öôÔ∏è Manage Products</a>
    <a href="#" id="logoutBtn" class="logout">üö™ Logout</a>
  </div>

  <div class="content">
    <div class="card">
      <h2>Manage Products</h2>
      <form id="productForm">
        <input id="prodId" type="hidden">
        <input id="pname" placeholder="Product name" required>
        <input id="pprice" type="number" placeholder="Price" required>
        <textarea id="pdesc" placeholder="Description"></textarea>

        <label style="font-weight:700;margin-top:8px">Images (up to 5 URLs)</label>
        <input id="img1" placeholder="Image 1 (required)">
        <input id="img2" placeholder="Image 2">
        <input id="img3" placeholder="Image 3">
        <input id="img4" placeholder="Image 4">
        <input id="img5" placeholder="Image 5">

        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <label><input id="poffer" type="checkbox"> Hot Offer</label>
          <button type="submit" style="background:#005bea;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer">Save</button>
          <button id="clearBtn" type="button" style="background:#eee;border:none;padding:8px 12px;border-radius:8px;cursor:pointer">Clear</button>
        </div>
      </form>
    </div>

    <div style="height:18px"></div>

    <div class="card">
      <h3>Existing Products</h3>
      <div id="productList" style="margin-top:12px"></div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBMcvOHM65rOqpZbwqSGI7LJm6lNc0dPo4",
    authDomain: "al-zoz-store.firebaseapp.com",
    projectId: "al-zoz-store",
    storageBucket: "al-zoz-store.firebasestorage.app",
    messagingSenderId: "977135794801",
    appId: "1:977135794801:web:43aae20e57879b8e9579d0",
    measurementId: "G-FG212CG4VE"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const adminEmail = "alihomekh@gmail.com";

  // Protect page (admin only)
  onAuthStateChanged(auth, (user)=>{
    if(!user) { window.location.href = 'login.html'; return; }
    if(user.email.toLowerCase() !== adminEmail.toLowerCase()){ alert('Access denied'); window.location.href='index.html'; return; }
    loadProducts();
  });

  document.getElementById('logoutBtn').addEventListener('click', ()=> signOut(auth).then(()=> location.href='login.html'));

  // Add / Update product
  document.getElementById('productForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = document.getElementById('prodId').value;
    const name = document.getElementById('pname').value;
    const price = parseFloat(document.getElementById('pprice').value);
    const desc = document.getElementById('pdesc').value;
    const images = [];
    for(let i=1;i<=5;i++){ const v = document.getElementById('img'+i).value; if(v) images.push(v); }
    const offer = document.getElementById('poffer').checked;
    try{
      if(id){
        await updateDoc(doc(db,'products',id), { name, price, desc, images, offer });
        alert('Product updated');
      } else {
        await addDoc(collection(db,'products'), { name, price, desc, images, offer, createdAt: serverTimestamp() });
        alert('Product added');
      }
      e.target.reset(); document.getElementById('prodId').value='';
      loadProducts();
    }catch(err){ console.error(err); alert('Failed: '+err.message); }
  });

  document.getElementById('clearBtn').addEventListener('click', ()=> {
    document.getElementById('productForm').reset();
    document.getElementById('prodId').value='';
  });

  async function loadProducts(){
    const list = document.getElementById('productList'); list.innerHTML='';
    const snap = await getDocs(collection(db,'products'));
    snap.forEach(docSnap=>{
      const p = docSnap.data(); const id = docSnap.id;
      const div = document.createElement('div'); div.style='display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #f0f0f0';
      div.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
        <img src="${(p.images&&p.images[0])?p.images[0]:(p.image||'https://picsum.photos/seed/placeholder/200/150')}" style="width:64px;height:48px;object-fit:cover;border-radius:6px">
        <div><strong>${p.name}</strong><div class="small-muted">$${p.price} ${p.offer?'<span style="background:#ff6a00;color:#fff;padding:4px 6px;border-radius:6px;margin-left:6px">HOT</span>':''}</div></div>
      </div>
      <div>
        <button onclick="editProduct('${id}')" style="margin-right:8px">Edit</button>
        <button onclick="deleteProduct('${id}')" style="background:#e63946;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer">Delete</button>
      </div>`;
      list.appendChild(div);
    });
  }

  window.editProduct = async (id) => {
    const docRef = doc(db,'products',id);
    const docSnap = await getDocs(collection(db,'products')); // workaround below
    // simpler: query getDoc
    const { getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
    const snap = await getDoc(docRef);
    if(!snap.exists()){ alert('Not found'); return; }
    const p = snap.data();
    document.getElementById('prodId').value = id;
    document.getElementById('pname').value = p.name || '';
    document.getElementById('pprice').value = p.price || '';
    document.getElementById('pdesc').value = p.desc || '';
    for(let i=1;i<=5;i++){ document.getElementById('img'+i).value = (p.images && p.images[i-1])? p.images[i-1] : ''; }
    document.getElementById('poffer').checked = !!p.offer;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  window.deleteProduct = async (id) => {
    if(!confirm('Delete product?')) return;
    await deleteDoc(doc(db,'products',id));
    loadProducts();
  };

</script>
</body>
</html>
